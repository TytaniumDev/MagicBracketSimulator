# Worker Orchestrator - Manages simulation containers via Docker socket
# Slim container: Node.js only, no Java/Forge

services:
  worker:
    image: ${IMAGE_NAME:-magic-bracket-worker}:${IMAGE_TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile
    container_name: magic-bracket-worker
    restart: unless-stopped
    env_file:
      - .env

    environment:
      # GCP Configuration
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT:-magic-bracket-simulator}
      - GOOGLE_APPLICATION_CREDENTIALS=/secrets/sa.json

      # Pub/Sub
      - PUBSUB_SUBSCRIPTION=${PUBSUB_SUBSCRIPTION:-job-created-worker}
      - PUBSUB_WORKER_REPORT_IN_SUBSCRIPTION=${PUBSUB_WORKER_REPORT_IN_SUBSCRIPTION:-worker-report-in-sub}

      # API — WORKER_SECRET comes from Secret Manager at runtime; URL is not secret
      - API_URL=${API_URL:-https://api--magic-bracket-simulator.us-central1.hosted.app}

      # Storage
      - GCS_BUCKET=${GCS_BUCKET:-magic-bracket-simulator-artifacts}

      # Worker
      - WORKER_ID=${WORKER_ID:-}
      - JOBS_DIR=/tmp/mbs-jobs

      # Simulation image (must be pre-pulled or built on host)
      - SIMULATION_IMAGE=${SIMULATION_IMAGE:-magic-bracket-simulation:latest}

      # Docker CLI API version — worker image ships Docker CLI v20 (API 1.41) but
      # newer daemons (v25+) require API ≥1.44. Override to negotiate correctly.
      - DOCKER_API_VERSION=1.44

    # Grant access to the host Docker socket (GID varies by runtime: Colima=991, Linux=999, etc.)
    # DOCKER_SOCK_GID is set by setup-worker.sh; falls back to 0 (root) if unset.
    group_add:
      - "${DOCKER_SOCK_GID:-0}"

    volumes:
      # Mount Docker socket so worker can spawn simulation containers
      - /var/run/docker.sock:/var/run/docker.sock

      # Shared temp directory for deck/log files (worker writes, simulation containers read/write)
      - /tmp/mbs-jobs:/tmp/mbs-jobs

      # GCP credentials
      - ${SA_KEY_PATH:-${GOOGLE_APPLICATION_CREDENTIALS:-~/.config/gcloud/application_default_credentials.json}}:/secrets/sa.json:ro

    # Resource limits — worker itself is lightweight (Node.js only)
    # Simulation containers have their own resource limits
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
