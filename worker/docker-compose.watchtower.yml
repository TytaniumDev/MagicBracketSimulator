# Watchtower auto-update overlay â€” polls GHCR for new worker images
# Usage: docker compose -f worker/docker-compose.yml -f worker/docker-compose.watchtower.yml up -d
#
# Requires GHCR_USER and GHCR_TOKEN env vars (or in worker/.env) for private repos.
# Generate a GitHub PAT with read:packages scope.
#
# Uses nickfedor/watchtower (containrrr/watchtower is archived and incompatible with Docker 29+ API 1.44).
#
# Simulation image updates: Watchtower only watches the worker container (simulation
# containers are ephemeral --rm). When the worker image is updated and restarted,
# ensureSimulationImage() in worker.ts pulls the latest simulation image on startup.

services:
  watchtower:
    image: nickfedor/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    environment:
      - DOCKER_API_VERSION=1.44
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_LABEL_ENABLE=true
      - REPO_USER=${GHCR_USER}
      - REPO_PASS=${GHCR_TOKEN}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  worker:
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
